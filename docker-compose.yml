version: '3.8'

services:
  guardian-log:
    build:
      context: .
      dockerfile: Dockerfile
    image: guardian-log:latest
    container_name: guardian-log
    restart: unless-stopped

    ports:
      - "8080:8080"

    volumes:
      # Persist database
      - ./data:/app/data
      # Optional: mount custom config (if you prefer file over env vars)
      # - ./.env:/app/.env:ro

    environment:
      # AdGuard Home Configuration
      AGH_URL: ${AGH_URL:-http://192.168.1.1:8080}
      AGH_USER: ${AGH_USER:-admin}
      AGH_PASS: ${AGH_PASS:-password}

      # Application Configuration
      POLL_INTERVAL: ${POLL_INTERVAL:-10s}
      DB_PATH: ${DB_PATH:-./data/guardian.db}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # LLM Configuration
      LLM_ENABLE: ${LLM_ENABLE:-true}
      LLM_PROVIDER: ${LLM_PROVIDER:-gemini}
      LLM_TIMEOUT: ${LLM_TIMEOUT:-30s}

      # Gemini Configuration
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-1.5-flash}

    networks:
      - guardian-net

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Resource limits (optional but recommended)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

networks:
  guardian-net:
    driver: bridge

volumes:
  guardian-data:
    driver: local
